#!/bin/bash

shopt -s nullglob globstar

recovery=( ~/.mozilla/firefox/*.default/sessionstore-backups/recovery.jsonlz4 )
[[ -n "$recovery" ]] || exit

fqdn=$(lz4jsoncat "$recovery" |
    jq -r '.windows[.selectedWindow - 1]|.tabs[.selected - 1].entries[-1].url' |
    sed -nE 's/^[^\/]*\/\/([^@\/]*@)?([^:\/]+)(:[^\/]+)?.*/\2/p')

prefix=${PASSWORD_STORE_DIR-~/.password-store}
name="$fqdn"
while [[ "${name}" =~ "." ]]; do
    password_files=( "$prefix"/"$name"/**/*.gpg )
    if [[ "${#password_files[@]}" -gt 0 ]]; then
        break
    fi
    name=${name#*.}
done
if [[ "${#password_files[@]}" -eq 0 ]]; then
    password_files=( "$prefix"/**/*.gpg )
fi
password_files=( "${password_files[@]#"$prefix"/}" )
password_files=( "${password_files[@]%.gpg}" )

password=$(printf '%s\n' "${password_files[@]}" | dmenu "$@")

[[ -n $password ]] || exit

pass show "$password" | { IFS= read -r pass; printf %s "$pass"; } |
    xdotool type --clearmodifiers --file -
